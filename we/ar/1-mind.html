<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AR 1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- three.js + MindAR (three 버전) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #container {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }
    #hint {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 16px;
      text-align: center;
      color: #fff;
      font-size: 13px;
      font-family: -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Segoe UI",Roboto,sans-serif;
      text-shadow: 0 1px 2px rgba(0,0,0,.7);
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="hint">로딩 중… 카메라 허용해줘.</div>

  <!-- AR용 비디오 (텍스처로 쓰는 용도) -->
  <video id="video1"
         src="./videos/1.mp4"
         playsinline
         webkit-playsinline
         muted
         preload="auto"
         style="display:none"></video>

<script>
  const hintEl = document.getElementById('hint');
  const videoEl = document.getElementById('video1');

  const setHint = (msg) => { hintEl.textContent = msg; };

  document.addEventListener("DOMContentLoaded", async () => {
    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
      container: document.querySelector("#container"),
      imageTargetSrc: "./mind/card1.mind",
      uiLoading: true,
      uiScanning: true,
      uiError: true,
    });

    const {renderer, scene, camera} = mindarThree;

    // 조명 (없어도 되지만 살짝 넣어줌)
    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(light);

    // 비디오 텍스처 준비
    const texture = new THREE.VideoTexture(videoEl);
    texture.encoding = THREE.sRGBEncoding;

    // 비디오가 맵핑될 평면 (비율 16:9 가정 → 1.6 : 0.9 정도)
    const geometry = new THREE.PlaneGeometry(1.4, 0.8);
    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
    const plane = new THREE.Mesh(geometry, material);

    // 0번 타겟에 붙이기
    const anchor = mindarThree.addAnchor(0);
    anchor.group.add(plane);

    anchor.onTargetFound = () => {
      setHint("인식됨! 화면을 한 번 터치하면 영상이 재생돼.");
      videoEl.play().catch(() => {/* iOS는 터치 필요할 수 있음 */});
    };
    anchor.onTargetLost = () => {
      setHint("타겟이 벗어났어. 다시 포토카드를 맞춰줘.");
      // 필요하면 pause
      // videoEl.pause();
    };

    // 비디오 준비되면 안내 문구 변경
    videoEl.addEventListener("canplay", () => {
      setHint("카메라 준비 완료! 1번 포토카드를 화면 가득 채워서 비춰줘.");
    });

    // iOS 자동재생 대응: 첫 터치에서 재생 시도
    document.body.addEventListener("touchend", () => {
      if (videoEl.paused) videoEl.play().catch(()=>{});
    }, {passive:true});

    // AR 시작
    const start = async () => {
      await mindarThree.start();
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    };

    try {
      await start();
    } catch (e) {
      console.error(e);
      setHint("AR 시작 중 오류가 발생했어. HTTPS/카메라 권한/브라우저를 확인해줘.");
    }
  });
</script>
</body>
</html>
