<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>소리가든 AR - 1번 카드</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }
      #message {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        color: #ffffff;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        text-shadow: 0 0 4px #000;
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="message">AR 포토카드를 화면 가운데에 보이도록 비춰 주세요.</div>

    <script>
      const start = async () => {
        const THREE = window.MINDAR.IMAGE.THREE;

        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.querySelector("#container"),
          imageTargetSrc: "./mind/card1.mind",
        });

        const { renderer, scene, camera } = mindarThree;

        const video = document.createElement("video");
        video.src = "./videos/1.mp4";
        video.crossOrigin = "anonymous";
        video.preload = "auto";
        video.playsInline = true;
        video.loop = false;
        video.muted = false;

        const texture = new THREE.VideoTexture(video);
        texture.encoding = THREE.sRGBEncoding;

        const geometry = new THREE.PlaneGeometry(1, 1.5);

        const material = new THREE.ShaderMaterial({
          uniforms: {
            map: { value: texture }
          },
          vertexShader: `
            varying vec2 vUv;
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,
          fragmentShader: `
            precision mediump float;
            uniform sampler2D map;
            varying vec2 vUv;

            void main() {
              vec4 texColor = texture2D(map, vUv);

              float maxRG = max(texColor.r, texColor.g);
              float blueStrength = texColor.b - maxRG;

              float key = smoothstep(0.05, 0.18, blueStrength);

              float alpha = (1.0 - key) * texColor.a;

              if (alpha < 0.01) discard;

              gl_FragColor = vec4(texColor.rgb, alpha);
            }
          `,
          side: THREE.DoubleSide,
          transparent: true,
        });

        const plane = new THREE.Mesh(geometry, material);

        const anchor = mindarThree.addAnchor(0);
        anchor.group.add(plane);

        const messageEl = document.getElementById("message");
        let isPlaying = false;

        const playVideo = async () => {
          try {
            await video.play();
            isPlaying = true;
          } catch (e) {}
        };

        anchor.onTargetFound = () => {
          messageEl.innerText =
            "카드가 인식되었어요. 화면을 한 번 터치하시면 영상이 재생됩니다.";
        };

        anchor.onTargetLost = () => {
          if (isPlaying) {
            video.pause();
            video.currentTime = 0;
            isPlaying = false;
          }
          messageEl.innerText =
            "카드가 화면에서 벗어났어요. 다시 카드 전체가 보이도록 비춰 주세요.";
        };

        document.body.addEventListener(
          "click",
          () => {
            if (!isPlaying) {
              playVideo();
            }
          },
          { passive: true }
        );

        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      };

      start();
    </script>
  </body>
</html>

