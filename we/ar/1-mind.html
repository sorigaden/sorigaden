<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AR 1</title>

  <!-- A-Frame + MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>

  <!-- ✅ 크로마키 스크립트 (로딩 실패 방지용, CDN만 추가) -->
  <script src="https://unpkg.com/aframe-chromakey-material@1.0.5/dist/aframe-chromakey-material.min.js"></script>

  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;}
    a-scene,canvas.a-canvas{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;}
    video.mindar-video{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
      object-fit:cover!important;z-index:1!important;opacity:1!important;visibility:visible!important;background:#000!important;}
    canvas.a-canvas{z-index:2!important;}
    .mindar-ui-overlay{z-index:3!important;}
    #hint{position:fixed;left:0;right:0;bottom:18px;color:#fff;text-align:center;font-size:13px;
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",Segoe UI,Roboto,Arial,sans-serif;z-index:4;}
  </style>
</head>
<body>
  <div id="hint">로딩 중… 카메라 허용 후 1번 포토카드를 비춰줘.</div>

  <a-scene
    mindar-image="imageTargetSrc: ./mind/card1.mind; uiScanning: true; filterMinCF:0.0001; filterBeta:0.001;"
    renderer="colorManagement:true,physicallyCorrectLights,logarithmicDepthBuffer:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    embedded
    id="scene">
    <a-assets timeout="15000">
      <video id="v1" src="./videos/1.mp4" preload="auto" playsinline webkit-playsinline muted crossorigin="anonymous"></video>
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">
      <!-- ✅ 파란색(0 0 1) 투명처리만 추가 -->
      <a-video src="#v1"
        position="0 0 0" rotation="0 0 0"
        width="1.4" height="2.0" scale="1.8 1.8 1.8" autoplay="true"
        material="shader: chromakey; color: 0 0 1; transparent: true; tolerance: 0.3;">
      </a-video>
    </a-entity>
  </a-scene>

  <script>
    const scene=document.getElementById('scene');
    const hint=document.getElementById('hint');
    const v1=document.getElementById('v1');

    // 카메라 비디오가 숨겨지는 버그 보정
    function fixCam(){
      const cam=document.querySelector('video.mindar-video');
      if(cam){
        cam.style.position='fixed';
        cam.style.inset='0';
        cam.style.width='100vw';
        cam.style.height='100vh';
        cam.style.objectFit='cover';
        cam.style.visibility='visible';
        cam.style.opacity='1';
      }
    }
    new MutationObserver(fixCam).observe(document.body,{childList:true,subtree:true});
    setInterval(fixCam,300);

    scene.addEventListener('arReady',()=>{
      fixCam();
      hint.textContent='카메라 준비 완료! 1번 포토카드를 비춰줘.';
    });
    scene.addEventListener('targetFound',()=>{
      v1.play().catch(()=>{});
      hint.textContent='인식됨!';
    });
    document.addEventListener('touchend',()=>{if(v1.paused)v1.play().catch(()=>{});},{passive:true});
  </script>
</body>
</html>
