<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>소리가든 AR - 1번 카드</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <!-- MindAR (브라우저용 UMD 번들 버전) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }

      #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }

      /* MindAR가 만드는 canvas 를 화면 가득 채우게 */
      canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }

      #message {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        color: #ffffff;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        text-shadow: 0 0 4px #000;
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="message">1번 인식! 화면 한 번 터치해서 영상 재생해줘.</div>

    <script>
      const start = async () => {
        const THREE = window.MINDAR.IMAGE.THREE;

        // 1번 마커(.mind) 파일 경로
        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.querySelector("#container"),
          imageTargetSrc: "./mind/card1.mind",
        });

        const { renderer, scene, camera } = mindarThree;

        // 1번 영상
        const video = document.createElement("video");
        video.src = "./videos/1.mp4";
        video.crossOrigin = "anonymous";
        video.preload = "auto";
        video.playsInline = true;
        video.loop = false;   // 필요하면 true 로
        video.muted = false;

        const texture = new THREE.VideoTexture(video);
        texture.encoding = THREE.sRGBEncoding;

        // 카드 비율에 맞춰서 적당히 세로 긴 직사각형
        const geometry = new THREE.PlaneGeometry(1, 1.5);
        const material = new THREE.MeshBasicMaterial({
          map: texture,
          side: THREE.DoubleSide,
        });
        const plane = new THREE.Mesh(geometry, material);

        const anchor = mindarThree.addAnchor(0); // 첫 번째 마커
        anchor.group.add(plane);

        let isPlaying = false;

        const playVideo = async () => {
          try {
            await video.play();
            isPlaying = true;
          } catch (e) {
            console.log("비디오 재생 오류:", e);
          }
        };

        anchor.onTargetFound = () => {
          document.getElementById("message").innerText =
            "1번 인식! 화면 한 번 터치해서 영상 재생해줘.";
        };

        anchor.onTargetLost = () => {
          if (isPlaying) {
            video.pause();
            video.currentTime = 0;
            isPlaying = false;
          }
        };

        // iOS 때문에 유저 제스처(터치)에서 재생
        document.body.addEventListener(
          "click",
          () => {
            if (!isPlaying) {
              playVideo();
            }
          },
          { passive: true }
        );

        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      };

      start();
    </script>
  </body>
</html>
