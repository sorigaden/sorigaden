<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>소리가든 AR - 2번 카드</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }
      #message {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        color: #ffffff;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        text-shadow: 0 0 4px #000;
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="message">2번 인식! 화면 한 번 터치해서 영상 재생해줘.</div>

    <script>
      const start = async () => {
        const THREE = window.MINDAR.IMAGE.THREE;

        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.querySelector("#container"),
          imageTargetSrc: "./mind/card2.mind",
        });

        const { renderer, scene, camera } = mindarThree;

        const video = document.createElement("video");
        video.src = "./videos/2.mp4";
        video.crossOrigin = "anonymous";
        video.preload = "auto";
        video.playsInline = true;
        video.loop = false;
        video.muted = false;

        const texture = new THREE.VideoTexture(video);
        texture.encoding = THREE.sRGBEncoding;

        const geometry = new THREE.PlaneGeometry(1, 1.5);

        const material = new THREE.ShaderMaterial({
          uniforms: {
            map: { value: texture },
            keyColor: { value: new THREE.Color(0x0040ff) },
            thresholdBlue: { value: 0.28 },
            whiteLumaMin: { value: 0.82 },
            whiteSatMax: { value: 0.10 }
          },
          vertexShader: `
            varying vec2 vUv;
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,
          fragmentShader: `
            precision mediump float;
            uniform sampler2D map;
            uniform vec3 keyColor;
            uniform float thresholdBlue;
            uniform float whiteLumaMin;
            uniform float whiteSatMax;
            varying vec2 vUv;

            void main() {
              vec4 texColor = texture2D(map, vUv);

              float distBlue = distance(texColor.rgb, keyColor);
              float blueKeep = smoothstep(thresholdBlue, thresholdBlue + 0.08, distBlue);

              float maxc = max(max(texColor.r, texColor.g), texColor.b);
              float minc = min(min(texColor.r, texColor.g), texColor.b);
              float sat = maxc - minc;
              float luma = dot(texColor.rgb, vec3(0.299, 0.587, 0.114));

              float isWhite = step(whiteLumaMin, luma) * step(sat, whiteSatMax);
              float whiteKeep = 1.0 - isWhite;

              float alpha = texColor.a * blueKeep * whiteKeep;

              gl_FragColor = vec4(texColor.rgb, alpha);
            }
          `,
          side: THREE.DoubleSide,
          transparent: true,
        });

        const plane = new THREE.Mesh(geometry, material);

        const anchor = mindarThree.addAnchor(0);
        anchor.group.add(plane);

        let isPlaying = false;

        const playVideo = async () => {
          try {
            await video.play();
            isPlaying = true;
          } catch (e) {}
        };

        anchor.onTargetFound = () => {
          document.getElementById("message").innerText =
            "2번 인식! 화면 한 번 터치해서 영상 재생해줘.";
        };

        anchor.onTargetLost = () => {
          if (isPlaying) {
            video.pause();
            video.currentTime = 0;
            isPlaying = false;
          }
        };

        document.body.addEventListener(
          "click",
          () => {
            if (!isPlaying) playVideo();
          },
          { passive: true }
        );

        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      };

      start();
    </script>
  </body>
</html>

