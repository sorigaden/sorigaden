<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>MindAR Debug</title>

  <!-- A-Frame & MindAR(고정 버전) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    #log {
      position: fixed; left: 8px; bottom: 8px; right: 8px;
      color:#0f0; font:12px/1.5 Menlo,Consolas,monospace; white-space:pre-wrap;
      background:rgba(0,0,0,.5); padding:8px; border:1px solid #0f0; border-radius:6px;
      max-height: 45vh; overflow:auto;
    }
    #hint {
      position: fixed; top: 8px; left: 8px; right: 8px;
      color:#fff; font:13px/1.5 -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",sans-serif;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
    }
  </style>
</head>
<body>
  <div id="hint">디버그 모드: 카메라/AR 이벤트와 네트워크 상태를 아래에 찍어줄게.</div>
  <div id="log">log...\n</div>

  <!-- 장면 -->
  <a-scene
    mindar-image="imageTargetSrc: ./mind/card1.mind; uiScanning: true; filterMinCF:0.0001; filterBeta:0.001;"
    renderer="colorManagement:true, physicallyCorrectLights"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    id="scene">

    <a-assets timeout="15000">
      <video id="v1" src="./videos/1.mp4" playsinline webkit-playsinline preload="auto" muted crossorigin="anonymous"></video>
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">
      <!-- 비디오 대신 큼직한 테스트 평면 하나도 함께 올려서 카메라가 실제로 도는지 바로 보자 -->
      <a-plane position="0 0 0" width="1.4" height="2.0" color="#ff8800" opacity="0.25"></a-plane>
      <a-video src="#v1" position="0 0 0" width="1.4" height="2.0" scale="1.8 1.8 1.8"></a-video>
    </a-entity>
  </a-scene>

  <script>
    const $log = document.getElementById('log');
    const log = (...args) => { console.log(...args); $log.textContent += args.join(' ') + "\n"; $log.scrollTop = $log.scrollHeight; };

    // 1) 기본 정보
    log("UA:", navigator.userAgent);
    log("HTTPS:", location.protocol);
    log("Referrer Policy OK");

    // 2) 권한 상태(사파리 일부 버전은 미지원일 수 있음)
    if (navigator.permissions?.query) {
      navigator.permissions.query({name:'camera'}).then(s => log("Permission(camera):", s.state)).catch(()=>{});
    }

    // 3) MindAR/A-Frame 이벤트 갈무리
    const scene = document.getElementById('scene');
    scene.addEventListener('arReady',   () => log("[MindAR] arReady"));
    scene.addEventListener('arError',   (e)=> log("[MindAR] arError:", e?.detail || e));
    scene.addEventListener('targetFound',  ()=> log("[MindAR] targetFound"));
    scene.addEventListener('targetLost',   ()=> log("[MindAR] targetLost"));
    scene.addEventListener('camerastart',  ()=> log("[MindAR] camerastart"));
    scene.addEventListener('camerastop',   ()=> log("[MindAR] camerastop"));

    // 4) 에셋 로드 상태
    const mind = fetch('./mind/card1.mind', {cache:'no-store'})
      .then(r => { log("[NET] card1.mind:", r.status, r.ok ? "OK" : "FAIL"); return r.blob(); })
      .catch(err => log("[NET] card1.mind fetch error:", err));

    const v = document.getElementById('v1');
    v.addEventListener('loadeddata', ()=> log("[VIDEO] loadeddata"));
    v.addEventListener('canplay',    ()=> log("[VIDEO] canplay"));
    v.addEventListener('play',       ()=> log("[VIDEO] play"));
    v.addEventListener('pause',      ()=> log("[VIDEO] pause"));
    v.addEventListener('error',      ()=> log("[VIDEO] error", v.error && v.error.code));

    // 5) 터치 시 수동재생(모바일 자동재생 정책 보조)
    document.body.addEventListener('touchstart', ()=> v.play().catch(()=>{}));
  </script>
</body>
</html>
